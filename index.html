<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Peak â€“ Black-Screen Fix</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#111;font-family:sans-serif;color:#fff}
    canvas{display:block;margin:auto;background:#111}
    #ui{position:absolute;top:12px;left:12px;font-size:14px;text-shadow:0 0 4px #000}
    #ui input{padding:4px 6px;border:none;border-radius:4px}
    #ui button{margin-left:6px;padding:6px 12px;border:none;border-radius:4px;background:#0bf;color:#fff;cursor:pointer;font-weight:bold}
    #pop{margin-left:12px}
  </style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">
  <label>Name:<input id="name" maxlength="12" value="Climber"></label>
  <button id="startBtn">Start / Re-spawn</button>
  <span id="pop">Players: <span id="count">0</span></span>
</div>

<script>
/* ---------- tiny safe-guard wrappers ---------- */
function safeDraw(fn){try{fn();}catch(e){console.error(e);}}
function safeUpdate(fn){try{fn();}catch(e){console.error(e);}}

/* ---------- CONFIG ---------- */
const STEP=3, GRAV=0.45, DAMP=0.97, MAX_V=9, ROCK_R=18, REACH=44, SYNC_MS=50;

/* ---------- CANVAS ---------- */
const c=document.getElementById('c'), ctx=c.getContext('2d');
function resize(){c.width=innerWidth;c.height=innerHeight;makeRocks();}
resize(); addEventListener('resize',resize);

/* ---------- INPUT ---------- */
const keys={};
addEventListener('keydown',e=>keys[e.key.toLowerCase()]=1);
addEventListener('keyup',  e=>keys[e.key.toLowerCase()]=0);
let mouseDown=0, mx=0,my=0;
c.addEventListener('mousedown',e=>{mouseDown=1;mx=e.clientX;my=e.clientY});
c.addEventListener('mouseup',  _=>mouseDown=0);
c.addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY});

/* ---------- BACKGROUND ---------- */
function drawBackground(){
  const g=ctx.createLinearGradient(0,0,0,c.height);
  g.addColorStop(0,'#0d1b2a');g.addColorStop(0.6,'#1b263b');g.addColorStop(1,'#415a77');
  ctx.fillStyle=g;ctx.fillRect(0,0,c.width,c.height);
}

/* ---------- PLAYER ---------- */
class Player{
  constructor(id,name,x,y){
    this.id=id;this.name=name;this.x=x;this.y=y;this.vx=this.vy=0;
    this.climb=false;this.color=`hsl(${Math.random()*360},70%,55%)`;
    this.armAngle=0;this.trail=[];
  }
  update(){
    if(this.id!==myId){safeDraw(()=>this.draw());return;}
    const left=keys['a']||keys['arrowleft'], right=keys['d']||keys['arrowright'], up=keys['w']||keys['arrowup'];
    if(left)this.vx-=0.3; if(right)this.vx+=0.3;
    if(!this.climb){this.vy+=GRAV;this.vx*=DAMP;this.vy*=DAMP;}
    else{ if(up)this.y-=1.9; if(keys['s']||keys['arrowdown'])this.y+=1.9; this.vx*=0.82;this.vy*=0.82;}
    if(mouseDown){
      const dx=mx-this.x,dy=my-this.y,d=Math.hypot(dx,dy);
      if(d<REACH&&d>ROCK_R){this.climb=true;this.vx+=dx/d*0.28;this.vy+=dy/d*0.28;}
    }else this.climb=false;
    for(const r of rocks){
      const dx=r.x-this.x,dy=r.y-this.y,d=Math.hypot(dx,dy);
      if(d<r.r){this.climb=true;const nx=dx/d,ny=dy/d,overlap=r.r-d;this.x-=nx*overlap*0.5;this.y-=ny*overlap*0.5;}
    }
    this.vx=Math.max(-MAX_V,Math.min(MAX_V,this.vx));
    this.vy=Math.max(-MAX_V,Math.min(MAX_V,this.vy));
    this.x+=this.vx;this.y+=this.vy;
    if(this.y>c.height+120){this.y=50;this.x=c.width/2;this.vx=this.vy=0;}
    this.armAngle+=0.15;
    this.trail.push({x:this.x,y:this.y});if(this.trail.length>8)this.trail.shift();
    safeDraw(()=>this.draw());
  }
  draw(){
    for(let i=0;i<this.trail.length;i++){
      const t=this.trail[i],a=i/this.trail.length;
      ctx.beginPath();ctx.arc(t.x,t.y,14*a,0,Math.PI*2);
      ctx.fillStyle=this.color.replace('55%)',(15+a*40)+'%)');ctx.fill();
    }
    ctx.save();ctx.translate(this.x,this.y);ctx.shadowBlur=20;ctx.shadowColor=this.color;
    ctx.beginPath();ctx.arc(0,0,15,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(-5,-2,2,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(5,-2,2,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(-10,4);ctx.lineTo(-14+Math.sin(this.armAngle)*3,12);ctx.stroke();
    ctx.beginPath();ctx.moveTo(10,4);ctx.lineTo(14+Math.sin(this.armAngle+1)*3,12);ctx.stroke();
    if(this.climb){ctx.beginPath();ctx.arc(0,0,REACH,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,.18)';ctx.lineWidth=2;ctx.stroke();}
    ctx.restore();
    ctx.fillStyle='#fff';ctx.font='bold 13px sans-serif';ctx.textAlign='center';ctx.fillText(this.name,this.x,this.y-24);
  }
}

/* ---------- ROCKS ---------- */
class Rock{
  constructor(x,y,r){this.x=x;this.y=y;this.r=r;this.base=`hsl(${30+Math.random()*20},40%,${25+r/2}%)`;this.pulse=0;}
  update(){this.pulse+=0.04;}
  draw(){ctx.save();ctx.translate(this.x,this.y);ctx.shadowBlur=14;ctx.shadowColor=this.base;ctx.beginPath();ctx.arc(0,0,this.r,0,Math.PI*2);ctx.fillStyle=this.base;ctx.fill();ctx.beginPath();ctx.arc(0,0,this.r-4,0,Math.PI*2);ctx.fillStyle=`hsl(30,30%,${40+Math.sin(this.pulse)*8}%)`;ctx.fill();ctx.restore();}
}
const rocks=[];
function makeRocks(){rocks.length=0;for(let i=0;i<60;i++)rocks.push(new Rock(Math.random()*c.width,Math.random()*(c.height-250)+150,ROCK_R+Math.random()*14));rocks.sort((a,b)=>b.y-a.y);}
makeRocks();addEventListener('resize',makeRocks);

/* ---------- NET ---------- */
const myId='id_'+Math.random().toString(36).slice(2,9);
let ws,players={};
function startWS(){
  if(ws){ws.close();}
  const wsUrl=(location.protocol==="file:")?"ws://localhost:8080":`wss://${location.host}`;
  ws=new WebSocket(wsUrl);
  ws.onopen=()=>{ws.send(JSON.stringify({type:'join',name:document.getElementById('name').value,id:myId}));};
  ws.onmessage=msg=>{
    const data=JSON.parse(msg.data);
    if(data.type==='state'){players={};for(const p of data.players)players[p.id]=new Player(p.id,p.name,p.x,p.y);}
    if(data.type==='update'){if(data.id!==myId&&players[data.id]){const t=players[data.id];t.x=data.x;t.y=data.y;t.vx=data.vx;t.vy=data.vy;t.climb=data.climb;}}
    if(data.type==='leave')delete players[data.id];
    document.getElementById('count').textContent=Object.keys(players).length;
  };
  ws.onclose=ws.onerror=_=>setTimeout(startWS,2000);
}
document.getElementById('startBtn').onclick=()=>{
  startWS();
  if(!players[myId])players[myId]=new Player(myId,document.getElementById('name').value,c.width/2,100);
};

/* ---------- SYNC ---------- */
let lastSync=0;
function sync(){
  const now=performance.now();
  if(now-lastSync>SYNC_MS&&ws&&ws.readyState===1&&players[myId]){
    const p=players[myId];
    ws.send(JSON.stringify({type:'update',id:myId,x:p.x,y:p.y,vx:p.vx,vy:p.vy,climb:p.climb}));
    lastSync=now;
  }
}

/* ---------- LOOP ---------- */
function loop(){
  safeDraw(drawBackground);
  for(const r of rocks){safeUpdate(()=>r.update());safeDraw(()=>r.draw());}
  for(const p of Object.values(players))safeUpdate(()=>p.update());
  sync();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
